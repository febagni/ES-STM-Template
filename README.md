# STM32 Project Template

Template for projects using ST microcontrollers and STM32CubeMX. It consists of a specific folder structure, a Makefile, and some configuration files.

## Requirements

* [STM32CubeMX](https://www.st.com/en/development-tools/stm32cubemx.html)
  > The installation path must be added to the `CUBE_PATH` environment variable.

* make
  > Linux: `sudo apt install make`
  >
  > Windows: `msys2> pacman -S make`

* [GNU Arm Embedded Toolchain](https://developer.arm.com/open-source/gnu-toolchain/gnu-rm/downloads)
  > The `bin` folder of this installation must be in the `PATH` and in an environment variable `ARM_GCC_PATH`.

* uncrustify
  > Linux: `sudo apt install uncrustify`
  >
  > Windows: Download the .zip from [SourceForge](https://sourceforge.net/projects/uncrustify/files/). Add the executable's location to the `PATH` environment variable.

* [Visual Studio Code](https://code.visualstudio.com/)
  * [EditorConfig](https://marketplace.visualstudio.com/items?itemName=EditorConfig.EditorConfig)
  * [C/C++](https://marketplace.visualstudio.com/items?itemName=ms-vscode.cpptools)
  * [Cortex-Debug](https://marketplace.visualstudio.com/items?itemName=marus25.cortex-debug)

* [STM32 Cube Programmer](https://www.st.com/en/development-tools/stm32cubeprog.html) or [J-Link](https://www.segger.com/downloads/jlink/)
  > The executable must also be in the `PATH`

## Preparation

### Project

First, create a Cube project in the `cube/` folder with the desired name. The project should have the following project options:

Project:

* Application Structure: *Basic*
* [x] Do not generate the main()
* Toolchain / IDE: *Makefile*

Code Generator:

* STM32Cube Firmware Library Package: *Copy only the necessary library files*
* Generated files:
  * *Generate peripheral initialization as a pair of .c/.h files per peripheral*
  * *Delete previously generated files when not re-generated*

An example file is located at `cube/stm32_project_template.ioc` with all the necessary configurations.

For existing projects, simply move the `.ioc` file to the `cube/` folder.

### Generating files

With the project file in the correct folder, execute the following commands (only necessary after checking out the repository or changing the Cube):

```bash
make cube     # Generate cube files
make prepare  # Delete unnecessary cube files and generate VS Code configuration files
```

If, after modifying the Cube files, any errors occur in the above commands, you can run `make clean_cube` to delete the generated files and then try again to generate them from scratch.

### [config.mk](config.mk)

The [config.mk](config.mk) file should be changed according to the project.

To do this, change the project name, which should be the same as the Cube file (for example, `stm32_project_template.ioc`), but without the `.ioc` extension (if you do not use Cube file versioning).

```Makefile
PROJECT_NAME = stm32_project_template
```

Also, change the following configurations:

```Makefile
DEVICE_FAMILY  := STM32F3xx
DEVICE_TYPE    := STM32F303xx
DEVICE_DEF     := STM32F303xE
DEVICE         := STM32F303RE
```

Simply take the full name of the microcontroller and put it in these configurations, following the pattern, making the necessary substitutions for `x`.

> If in doubt, check the name of the `.ld` file generated in the `cube` folder; it contains the full name of the microcontroller.

> If you are using the STM32G0 family, the `DEVICE_DEF` variable should be equal to `DEVICE_TYPE`.

Additionally, the full name of the `.ld` file with the extension should be placed in `DEVICE_LD_FILE`.

```Makefile
# Linker script file without .ld extension
# Find it on cube folder after code generation
DEVICE_LD_FILE := STM32F303RETx_FLASH
```

The following configurations do not need to be changed; they define directory names and compilation options. It is recommended to keep them with their default values:

```Makefile
# Lib dir
LIB_DIR  := lib

# Cube Directory
CUBE_DIR := cube

# Config Files Directory
CFG_DIR :=

# Tests Directory
TEST_DIR := tests

# Default values, can be set on the command line or here
DEBUG   ?= 1
VERBOSE ?= 0
TEST    ?= 0
```

## Compilation

To compile the files, run

```bash
make
```

Sometimes, it is necessary to clean the already compiled files if an error occurs. To do this, use:

```bash
make clean
```

This deletes all generated compilation files, except those generated from the ST libraries generated by Cube. This is done to speed up a new build since it is rarely necessary to recompile these files. If necessary, you can clean all compilation files with

```bash
make clean_all
```

## Flashing

To flash the files to the board, run

```bash
make flash
```

Or, if using a J-Link programmer:

```bash
make jflash
```

## Tasks

In Visual Studio Code, you can press `CTRL`+`SHIFT`+`B` and choose one of the options from the list to execute compilation and flashing commands more quickly.

* Clean Project (_make clean_)
* Build Project (_make_)
* Rebuild Project (_make clean && make_)
* Flash Program (_make flash_)
* Build and Flash (_make && make flash_)

## Submodules

### Adding a submodule

Create a directory called `lib` and add the submodule to it.

Example:

```bash
mkdir lib
git submodule add --name STMSensors git@github.com:ThundeRatz/STMSensors.git lib/STMSensors
```

### Initializing an existing submodule

When cloning a repository that already has submodules, it is necessary to clone the repositories of these submodules. This can be done in two ways, either by cloning along with the project repository or after already cloning.

Example:

To clone along with the project, use:

```bash
git clone --recurse-submodules git@github.com:ThundeRatz/STM32ProjectTemplate.git
```

To clone after already cloning the project repository:

```bash
git submodule update --init
```

## Tests Directory

The directory defined by the `TEST_DIR` variable contains files for testing specific parts of the project, separating this from the project code itself. These files should be implemented according to the developers' needs.

To enable the compilation and flashing of tests, set the value of the `TEST_NAME` variable to the name of the test file you want to use. This can be done either in the `config.mk` file or on the command line when running `make`, for example:

```bash
make flash TEST_NAME=test_digital_sensors
```

If the value of the `TEST_NAME` variable is empty, the test

 mode will not be used.

Note that the `make clean` command, when `TEST_NAME` is not empty, will delete the compilation files related to the test files.

Each test file in the test directory works independently. Each one must have a `main()` function, and each is compiled, flashed, and executed separately.

Note that the test name does not include the file extension.
